
     
    <script>
// Baserow API configuration
const BASEROW_API_URL = 'https://api.baserow.io/api/database/rows/table/';
const BASEROW_API_KEY = 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL';
const BASEROW_TABLE_ID = '561419';
const BASEROW_EMAIL_FIELD_ID = '4502368';

// Check if user is already logged in
window.addEventListener('load', function() {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const userEmail = localStorage.getItem('userEmail');
    
    if (isLoggedIn === 'true' && userEmail) {
        showDashboard();
        loadUserData();
        fetchUserApplicationsFromBaserow(userEmail);
        
        // Set last login time
        const lastLogin = localStorage.getItem('lastLoginTime') || new Date().toISOString();
        document.getElementById('lastLoginTime').textContent = formatDate(new Date(lastLogin));
        localStorage.setItem('lastLoginTime', new Date().toISOString());
        
        // Start real application tracking if there are pending applications
        const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
        const pendingApplications = applications.filter(app => app.status === 'Pending');
        
        if (pendingApplications.length > 0) {
            startRealApplicationTracking(pendingApplications[0]);
        } else {
            document.getElementById('applicationTrackingSection').style.display = 'none';
        }
    }
});

// Update the checkEmailInBaserow function to use the specific field ID
async function checkEmailInBaserow(email) {
    try {
        const response = await fetch(`${BASEROW_API_URL}${BASEROW_TABLE_ID}/?user_field_names=false&size=200`, {
            method: 'GET',
            headers: {
                'Authorization': `Token ${BASEROW_API_KEY}`
            }
        });

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        const data = await response.json();

        // Use the field ID directly (instead of assuming it's named "Email")
        return data.results.some(result => {
            const emailFieldValue = result[`field_${BASEROW_EMAIL_FIELD_ID}`];
            return emailFieldValue && emailFieldValue.toLowerCase().trim() === email.toLowerCase().trim();
        });

    } catch (error) {
        console.error('Error checking email in Baserow:', error);
        return false;
    }
}

// Login form submission - Step 1: Email verification
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const pinInputGroup = document.getElementById('pinInputGroup');
    const forgotPinSection = document.getElementById('forgotPinSection');
    const loginButton = document.getElementById('loginButton');
    const backButton = document.getElementById('backButton');
    
    // If PIN field is visible, this is step 2
    if (pinInputGroup.style.display === 'block') {
        const pin = document.getElementById('pin').value.trim();
        
        if (!pin) {
            alert('Please enter your PIN.');
            return;
        }
        
        // Show loading state
        const originalBtnText = loginButton.innerHTML;
        loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        loginButton.disabled = true;
        
        try {
            // Verify PIN
            const savedPin = localStorage.getItem(`pin_${email}`);
            
            if (pin !== savedPin) {
                alert('Incorrect PIN. Please try again.');
                document.getElementById('pin').value = '';
                document.getElementById('pin').focus();
                loginButton.innerHTML = originalBtnText;
                loginButton.disabled = false;
                return;
            }
            
            // Login successful
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('lastLoginTime', new Date().toISOString());
            
            // Fetch user data from Baserow
            await fetchUserApplicationsFromBaserow(email);
            
            showDashboard();
            loadUserData();
            
            // Start real application tracking if there are pending applications
            const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
            const pendingApplications = applications.filter(app => app.status === 'Pending');
            
            if (pendingApplications.length > 0) {
                startRealApplicationTracking(pendingApplications[0]);
            } else {
                document.getElementById('applicationTrackingSection').style.display = 'none';
            }
            
        } catch (error) {
            console.error('Login error:', error);
            alert('An error occurred during login. Please try again.');
            loginButton.innerHTML = originalBtnText;
            loginButton.disabled = false;
        }
        
        return;
    }
    
    // This is step 1: Email verification
    if (!email) {
        alert('Please enter your email address.');
        return;
    }
    
    // Always save email on device first
    localStorage.setItem('userEmail', email);
    
    // Show loading state
    const originalBtnText = loginButton.innerHTML;
    loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    loginButton.disabled = true;
    
    try {
        // Check if email exists in Baserow using specific field ID
        const userExists = await checkEmailInBaserow(email);
        
        if (!userExists) {
            alert('No applications found with this email address. Please apply for a loan first.');
            loginButton.innerHTML = originalBtnText;
            loginButton.disabled = false;
            return;
        }
        
        // Check if user has a PIN set
        const savedPin = localStorage.getItem(`pin_${email}`);
        
        if (!savedPin) {
            // First time login - show PIN creation form
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('createPinForm').style.display = 'block';
            
            // Store email temporarily for PIN creation
            sessionStorage.setItem('tempEmail', email);
            
            loginButton.innerHTML = originalBtnText;
            loginButton.disabled = false;
            return;
        }
        
        // Show PIN input for returning user
        document.getElementById('email').readOnly = true;
        pinInputGroup.style.display = 'block';
        forgotPinSection.style.display = 'block';
        loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
        backButton.style.display = 'block';
        document.getElementById('pin').focus();
        
        loginButton.innerHTML = originalBtnText;
        loginButton.disabled = false;
        
    } catch (error) {
        console.error('Login error:', error);
        alert('An error occurred during login. Please try again.');
        loginButton.innerHTML = originalBtnText;
        loginButton.disabled = false;
    }
});

// Back button handler
document.getElementById('backButton').addEventListener('click', function() {
    document.getElementById('email').readOnly = false;
    document.getElementById('pinInputGroup').style.display = 'none';
    document.getElementById('forgotPinSection').style.display = 'none';
    document.getElementById('loginButton').innerHTML = '<i class="fas fa-arrow-right"></i> Continue';
    this.style.display = 'none';
});

// PIN Creation Form
document.getElementById('createPinForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newPin = document.getElementById('newPin').value;
    const confirmPin = document.getElementById('confirmPin').value;
    const email = sessionStorage.getItem('tempEmail');
    
    if (newPin !== confirmPin) {
        alert('PINs do not match. Please try again.');
        return;
    }
    
    if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
        alert('PIN must be exactly 4 digits.');
        return;
    }
    
    // Save PIN
    localStorage.setItem(`pin_${email}`, newPin);
    
    // Clear session storage
    sessionStorage.removeItem('tempEmail');
    
    // Login successful
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('lastLoginTime', new Date().toISOString());
    
    // Fetch user data and show dashboard
    fetchUserApplicationsFromBaserow(email).then(() => {
        showDashboard();
        loadUserData();
        
        // Start real application tracking if there are pending applications
        const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
        const pendingApplications = applications.filter(app => app.status === 'Pending');
        
        if (pendingApplications.length > 0) {
            startRealApplicationTracking(pendingApplications[0]);
        } else {
            document.getElementById('applicationTrackingSection').style.display = 'none';
        }
    });
});

// Show dashboard function
function showDashboard() {
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
}

// Load user data function
function loadUserData() {
    const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
    const userEmail = localStorage.getItem('userEmail');
    
    if (applications.length > 0) {
        const firstApp = applications[0];
        const firstName = firstApp.firstName || 'User';
        const lastName = firstApp.lastName || '';
        const fullName = `${firstName} ${lastName}`.trim();
        
        const app = applications[0];
document.getElementById('profileAmount').textContent = `R${parseInt(app.loanAmount).toLocaleString()}`;
document.getElementById('profilePurpose').textContent = app.loanPurpose;
document.getElementById('profileTerm').textContent = `${app.loanTerm} months`;
document.getElementById('profileIncome').textContent = `R${parseInt(app.monthlyIncome).toLocaleString()}`;
document.getElementById('profileName').textContent = app.firstName;
        
        // Create avatar initials
        const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
        document.getElementById('userAvatar').textContent = initials;
        
        // Update settings form
        document.getElementById('settingsFirstName').value = firstName;
        document.getElementById('settingsLastName').value = lastName;
        document.getElementById('settingsEmail').value = userEmail;
        document.getElementById('settingsPhone').value = firstApp.phone || '';
    }
    
    loadApplications();
}

// Load applications function
function loadApplications() {
    const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
    const applicationsList = document.getElementById('applicationsList');
    
    // Update summary cards
const totalApps = applications.length;
const approvedApps = applications.filter(app => {
    // Check if application has reached 100% progress or is marked as Approved
    const savedProgress = localStorage.getItem(`progress_${app.referenceNumber}`);
    return app.status === 'Approved' || savedProgress === '100';
});
const pendingApps = applications.filter(app => app.status === 'Pending' || app.status === 'Processing');

document.getElementById('totalApplications').textContent = totalApps;
document.getElementById('approvedApplications').textContent = approvedApps.length;
document.getElementById('pendingApplications').textContent = pendingApps.length;
    
    if (totalApps > 0) {
        const approvalRate = Math.round((approvedApps.length / totalApps) * 100);
        document.getElementById('approvalRate').textContent = approvalRate;
    }
    
    if (applications.length === 0) {
        applicationsList.innerHTML = `
            <div class="no-applications">
                <i class="fas fa-file-alt"></i>
                <p>No loan applications found.</p>
                <a href="apply.html" class="action-btn btn-apply">
                    <i class="fas fa-plus"></i> Apply for a Loan
                </a>
            </div>
        `;
        return;
    }
    
    let html = '';
    applications.forEach(app => {
        const amount = parseInt(app.loanAmount) || 0;
        const statusClass = getStatusClass(app.status);
        
        html += `
            <div class="application-card">
                <div class="application-header">
                    <div class="application-title">${app.loanType} Loan</div>
                    <div class="application-status ${statusClass}">${app.status}</div>
                </div>
                <div class="application-details">
                    <div class="detail-item">
                        <div class="detail-label">Reference Number</div>
                        <div class="detail-value">${app.referenceNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Amount</div>
                        <div class="detail-value">R${amount.toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Purpose</div>
                        <div class="detail-value">${app.loanPurpose}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Term</div>
                        <div class="detail-value">${app.loanTerm} months</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Application Date</div>
                        <div class="detail-value">${formatDate(new Date(app.applicationDate))}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Monthly Income</div>
                        <div class="detail-value">R${parseInt(app.monthlyIncome || 0).toLocaleString()}</div>
                    </div>
                </div>
                <div class="application-actions">
                    <button class="application-btn btn-view" onclick="viewApplication('${app.referenceNumber}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    ${app.status === 'Approved' ? 
                        `<button class="application-btn btn-track" onclick="viewApprovalLetter('${app.referenceNumber}')">
                            <i class="fas fa-file-pdf"></i> View Letter
                        </button>` : 
                        `<button class="application-btn btn-track" onclick="trackApplication('${app.referenceNumber}')">
                            <i class="fas fa-search"></i> Track
                        </button>`
                    }
                </div>
            </div>
        `;
    });
    
    applicationsList.innerHTML = html;
    
    // Load other sections
    loadActiveLoans(approvedApps);
    populatePaymentLoanDropdown(approvedApps);
    loadDocuments(applications);
    loadPayments();
}

// Helper functions
function getStatusClass(status) {
    switch(status) {
        case 'Approved': return 'status-approved';
        case 'Pending': return 'status-pending';
        case 'Processing': return 'status-processing';
        case 'Rejected': return 'status-rejected';
        default: return 'status-pending';
    }
}

function formatDate(date) {
    return date.toLocaleDateString('en-ZA', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function determineApplicationStatus(result) {
    // Simple logic to determine status based on creation date
    const createdDate = new Date(result.created_on);
    const now = new Date();
    const minutesPassed = Math.floor((now - createdDate) / (1000 * 60));
    
    if (minutesPassed >= 10) {
        return 'Approved';
    } else if (minutesPassed >= 1) {
        return 'Processing';
    } else {
        return 'Pending';
    }
}

function getInterestRate(loanType) {
    switch(loanType) {
        case 'Personal': return 3;
        case 'Business': return 4;
        case 'Vehicle': return 2.5;
        case 'Home': return 2;
        default: return 3;
    }
}

function calculateMonthlyPayment(amount, rate, term) {
    const monthlyRate = rate / 100 / 12;
    const payment = (amount * monthlyRate * Math.pow(1 + monthlyRate, term)) / 
                   (Math.pow(1 + monthlyRate, term) - 1);
    return Math.round(payment);
}

function updateApplicationStatus(referenceNumber, status) {
    const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
    const appIndex = applications.findIndex(app => app.referenceNumber === referenceNumber);
    
    if (appIndex !== -1) {
        applications[appIndex].status = status;
        localStorage.setItem('loanApplications', JSON.stringify(applications));
        loadApplications();
    }
}

// Real application tracking with actual timing and advanced progress bar
function startRealApplicationTracking(application) {
    const progressBar = document.getElementById('trackingProgressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    const steps = document.querySelectorAll('.tracking-step');
    const trackingMessage = document.getElementById('trackingMessage');
    const trackingActions = document.getElementById('trackingActions');
    
    // Check if we have a saved progress state that's less than 30 days old
    const savedProgress = localStorage.getItem(`progress_${application.referenceNumber}`);
    const savedProgressDate = localStorage.getItem(`progress_date_${application.referenceNumber}`);
    
    if (savedProgress && savedProgressDate) {
        const progressDate = new Date(savedProgressDate);
        const now = new Date();
        const daysDiff = (now - progressDate) / (1000 * 60 * 60 * 24);
        
        // If progress is saved and less than 30 days old, use it
        if (daysDiff < 30 && savedProgress === '100') {
            // Show 100% progress (fully approved) with animation
            animateProgressBar(100);
            steps.forEach(step => step.classList.add('completed'));
            
            trackingMessage.innerHTML = `
                <strong>Congratulations!</strong> Your loan application has been <strong>APPROVED</strong>.<br>
                <strong>Flagged for Low Credit Issue</strong><br>
                A credit improvement and cover will be needed.<br>
                <small style="color: #e74c3c; font-weight: bold;">Do not worry, we have the solution for you!</small><br><br>
                <strong>Your approval letter is ready!</strong>
            `;
            
            trackingActions.style.display = 'block';
            updateApplicationStatus(application.referenceNumber, 'Approved');
            return;
        }
    }
    
    const createdDate = new Date(application.applicationDate);
    const now = new Date();
    const timeDiff = now - createdDate;
    const minutesPassed = Math.floor(timeDiff / (1000 * 60));
    
    // Reset tracking
    steps.forEach(step => step.classList.remove('active', 'completed'));
    trackingActions.style.display = 'none';
    
    if (minutesPassed < 1) {
        // Initial state: 30% - Application submitted and processing
        animateProgressBar(30);
        steps[0].classList.add('active');
        trackingMessage.innerHTML = `Your application has been submitted and is now being processed. We'll update you shortly.`;
        
        // Save progress state
        localStorage.setItem(`progress_${application.referenceNumber}`, '30');
        localStorage.setItem(`progress_date_${application.referenceNumber}`, now.toISOString());
        
        // Set timer for next update
        setTimeout(() => {
            checkTrackingProgress(application);
        }, (1 - minutesPassed) * 60000); // Wait until 1 minute mark
        
    } else if (minutesPassed < 5) {
        // 1-5 minutes: 75% - Qualified
        animateProgressBar(75);
        steps[0].classList.add('completed');
        steps[1].classList.add('completed');
        steps[2].classList.add('active');
        
        const firstName = application.firstName || 'Applicant';
        const amount = parseInt(application.loanAmount).toLocaleString();
        trackingMessage.innerHTML = `<strong>Congratulations ${firstName}!</strong> You have qualified for the R${amount} loan application. We are processing for approval and payout.`;
        
        // Save progress state
        localStorage.setItem(`progress_${application.referenceNumber}`, '75');
        localStorage.setItem(`progress_date_${application.referenceNumber}`, now.toISOString());
        
        // Set timer for next update
        setTimeout(() => {
            checkTrackingProgress(application);
        }, (5 - minutesPassed) * 60000); // Wait until 5 minute mark
        
    } else if (minutesPassed < 10) {
        // 5-10 minutes: 100% - Approved but flagged
        animateProgressBar(100);
        steps[0].classList.add('completed');
        steps[1].classList.add('completed');
        steps[2].classList.add('completed');
        steps[3].classList.add('completed');
        steps[4].classList.add('active');
        
        trackingMessage.innerHTML = `
            <strong>Congratulations!</strong> Your loan application has been <strong>APPROVED</strong>.<br>
            <strong>Flagged for Low Credit Issue</strong><br>
            A credit improvement cover will be needed.<br>
            <small style="color: #e74c3c; font-weight: bold;">Do not worry, we have the solution for you!</small><br><br>
            <em>Generating your contract letter...</em>
        `;
        
        // Save progress state
        localStorage.setItem(`progress_${application.referenceNumber}`, '100');
        localStorage.setItem(`progress_date_${application.referenceNumber}`, now.toISOString());
        
        // Show approval letter button after 30 seconds
        setTimeout(() => {
            trackingActions.style.display = 'block';
            trackingMessage.innerHTML = `
                <strong>Congratulations!</strong> Your loan application has been <strong>APPROVED</strong>.<br>
                <strong>Flagged for Low Credit Issue</strong><br>
                A credit improvement cover will be needed.<br>
                <small style="color: #e74c3c; font-weight: bold;">Do not worry, we have the solution for you!</small><br><br>
                <strong>Your Agreement contract is ready!</strong>
            `;
            
            // Update application status
            updateApplicationStatus(application.referenceNumber, 'Approved');
        }, 30000); // 30 seconds for letter generation
        
    } else {
        // 10+ minutes: Fully approved
        animateProgressBar(100);
        steps.forEach(step => step.classList.add('completed'));
        
        trackingMessage.innerHTML = `
            <strong>Congratulations!</strong> Your loan application has been <strong>APPROVED</strong>.<br>
            <strong>Flagged for Low Credit Issue</strong><br>
            A credit improvement cover will be needed.<br>
            <small style="color: #e74c3c; font-weight: bold;">Do not worry, we have the solution for you!</small><br><br>
            <strong>Your Agreement contract is ready!</strong>
        `;
        
        trackingActions.style.display = 'block';
        updateApplicationStatus(application.referenceNumber, 'Approved');
        
        // Save progress state
        localStorage.setItem(`progress_${application.referenceNumber}`, '100');
        localStorage.setItem(`progress_date_${application.referenceNumber}`, now.toISOString());
    }
}

// Animate progress bar with counting
function animateProgressBar(targetPercentage) {
    const progressBar = document.getElementById('trackingProgressBar');
    const progressPercentage = document.getElementById('progressPercentage');
    
    // Get current width
    const currentWidth = parseInt(progressBar.style.width || '0');
    const duration = 1500; // Animation duration in ms
    const frameRate = 30; // Frames per second
    const totalFrames = duration / (1000 / frameRate);
    const increment = (targetPercentage - currentWidth) / totalFrames;
    
    let currentFrame = 0;
    let currentPercentage = currentWidth;
    
    // Update progress percentage position
    progressPercentage.style.right = (100 - targetPercentage) + '%';
    
    const animationInterval = setInterval(() => {
        currentFrame++;
        currentPercentage += increment;
        
        if (currentFrame >= totalFrames) {
            clearInterval(animationInterval);
            currentPercentage = targetPercentage;
        }
        
        progressBar.style.width = currentPercentage + '%';
        progressPercentage.textContent = Math.round(currentPercentage) + '%';
        
        if (currentFrame >= totalFrames) {
            // Animation complete
            if (targetPercentage >= 100) {
                progressPercentage.style.background = '#27ae60';
            }
        }
    }, 1000 / frameRate);
}

// Check tracking progress and update accordingly
function checkTrackingProgress(application) {
    const createdDate = new Date(application.applicationDate);
    const now = new Date();
    const timeDiff = now - createdDate;
    const minutesPassed = Math.floor(timeDiff / (1000 * 60));
    
    if (minutesPassed >= 1 && minutesPassed < 5) {
        // Update to 75% - Qualified
        const steps = document.querySelectorAll('.tracking-step');
        const trackingMessage = document.getElementById('trackingMessage');
        
        animateProgressBar(75);
        steps[0].classList.add('completed');
        steps[1].classList.add('completed');
        steps[2].classList.add('active');
        
        const firstName = application.firstName || 'Applicant';
        const amount = parseInt(application.loanAmount).toLocaleString();
        trackingMessage.innerHTML = `<strong>Congratulations ${firstName}!</strong> You have qualified for the R${amount} loan application. We are processing for approval and payout.`;
        
        // Save progress state
        localStorage.setItem(`progress_${application.referenceNumber}`, '75');
        localStorage.setItem(`progress_date_${application.referenceNumber}`, now.toISOString());
        
        // Set timer for next update
        setTimeout(() => {
            checkTrackingProgress(application);
        }, (5 - minutesPassed) * 60000);
        
    } else if (minutesPassed >= 5) {
        // Update to 100% - Approved
        startRealApplicationTracking(application); // Re-run to show final state
    }
}

// Improve the fetchUserApplicationsFromBaserow function to get all user data
async function fetchUserApplicationsFromBaserow(email) {
    try {
        const response = await fetch(`${BASEROW_API_URL}${BASEROW_TABLE_ID}/?user_field_names=true`, {
            method: 'GET',
            headers: {
                'Authorization': `Token ${BASEROW_API_KEY}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Filter results by email using field ID
const userRecords = data.results.filter(result => 
    result[`field_${BASEROW_EMAIL_FIELD_ID}`] &&
    result[`field_${BASEROW_EMAIL_FIELD_ID}`].toLowerCase().trim() === email.toLowerCase().trim()
);
        
        if (userRecords.length === 0) {
            return;
        }
        
        // Process and store applications with all Baserow fields
        const applications = userRecords.map(result => {
            return {
    id: result.id,
    referenceNumber: `OPF-${String(result.id).padStart(5, '0')}`,
    loanType: result.loanType || '',
    loanAmount: result.field_4501398 || '',
    loanPurpose: result.field_4502388 || '',
    loanTerm: result.field_4502389 || '',
    firstName: result.field_4501396 || '',
    lastName: result.lastname || '',
    idNumber: result.field_4502424 || '',
    email: result.field_4502368 || '',
    phone: result.field_4502370 || '',
    employmentStatus: result.field_4502375 || '',
    monthlyIncome: result.field_4502376 || '',
    applicationDate: result.created_on || new Date().toISOString(),
    status: determineApplicationStatus(result),
    baserowId: result.id
};

        });
        
        localStorage.setItem('loanApplications', JSON.stringify(applications));
        loadApplications();
        
    } catch (error) {
        console.error('Error fetching applications from Baserow:', error);
        loadApplications(); // Load from local storage as fallback
    }
}

// Add function to load active loans
function loadActiveLoans(approvedLoans) {
    const activeLoanslist = document.getElementById('activeLoanslist');
    const noLoansMessage = document.getElementById('noLoansMessage');
    
    if (!approvedLoans || approvedLoans.length === 0) {
        // No active loans
        document.getElementById('totalLoanAmount').textContent = 'R0';
        document.getElementById('monthlyPayment').textContent = 'R0';
        document.getElementById('outstandingBalance').textContent = 'R0';
        document.getElementById('activeLoanCount').textContent = '0';
        document.getElementById('nextPaymentDate').textContent = 'N/A';
        document.getElementById('paidOffPercentage').innerHTML = '<i class="fas fa-arrow-down"></i> 0% paid off';
        
        noLoansMessage.style.display = 'block';
        return;
    }
    
    // Hide no loans message
    noLoansMessage.style.display = 'none';
    
    // Calculate totals
    let totalAmount = 0;
    let totalMonthlyPayment = 0;
    let totalOutstanding = 0;
    
    approvedLoans.forEach(loan => {
        const amount = parseInt(loan.loanAmount) || 0;
        const interestRate = getInterestRate(loan.loanType);
        const term = parseInt(loan.loanTerm) || 12;
        
        totalAmount += amount;
        
        const monthlyPayment = calculateMonthlyPayment(amount, interestRate, term);
        totalMonthlyPayment += monthlyPayment;
        
        // Assume 10% paid off for demonstration
        const outstanding = amount * 0.9;
        totalOutstanding += outstanding;
    });
    
    // Update summary cards
    document.getElementById('totalLoanAmount').textContent = `R${totalAmount.toLocaleString()}`;
    document.getElementById('monthlyPayment').textContent = `R${totalMonthlyPayment.toLocaleString()}`;
    document.getElementById('outstandingBalance').textContent = `R${Math.round(totalOutstanding).toLocaleString()}`;
    document.getElementById('activeLoanCount').textContent = approvedLoans.length;
    
    // Calculate next payment date (15th of next month)
    const nextPayment = new Date();
    nextPayment.setMonth(nextPayment.getMonth() + 1);
    nextPayment.setDate(15);
    document.getElementById('nextPaymentDate').textContent = formatDate(nextPayment);
    
    // Calculate paid off percentage
    const paidOffPercentage = Math.round(((totalAmount - totalOutstanding) / totalAmount) * 100);
    document.getElementById('paidOffPercentage').innerHTML = `<i class="fas fa-arrow-down"></i> ${paidOffPercentage}% paid off`;
    
    // Generate active loans HTML
    let html = '';
    approvedLoans.forEach(loan => {
        const amount = parseInt(loan.loanAmount) || 0;
        const interestRate = getInterestRate(loan.loanType);
        const term = parseInt(loan.loanTerm) || 12;
        const monthlyPayment = calculateMonthlyPayment(amount, interestRate, term);
        const outstanding = amount * 0.9; // Assume 10% paid off
        
        html += `
            <div class="application-card">
                <div class="application-header">
                    <div class="application-title">${loan.loanType} Loan</div>
                    <div class="application-status status-approved">Active</div>
                </div>
                <div class="application-details">
                    <div class="detail-item">
                        <div class="detail-label">Reference Number</div>
                        <div class="detail-value">${loan.referenceNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Loan Amount</div>
                        <div class="detail-value">R${amount.toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Monthly Payment</div>
                        <div class="detail-value">R${monthlyPayment.toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Outstanding Balance</div>
                        <div class="detail-value">R${Math.round(outstanding).toLocaleString()}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Interest Rate</div>
                        <div class="detail-value">${interestRate}% p.a.</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Loan Term</div>
                        <div class="detail-value">${term} months</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Next Payment</div>
                        <div class="detail-value">${formatDate(nextPayment)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">In Good Standing</div>
                    </div>
                </div>
                <div class="application-actions">
                    <button class="application-btn btn-view" onclick="viewLoanDetails('${loan.referenceNumber}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    <button class="application-btn btn-track" onclick="viewApprovalLetter('${loan.referenceNumber}')">
                        <i class="fas fa-file-pdf"></i> View Approval Letter
                    </button>
                </div>
            </div>
        `;
    });
    
    activeLoanslist.innerHTML = html;
}

// Add function to populate payment loan dropdown
function populatePaymentLoanDropdown(approvedLoans) {
    const paymentLoanSelect = document.getElementById('paymentLoan');
    
    // Clear existing options
    paymentLoanSelect.innerHTML = '<option value="">Select loan</option>';
    
    if (!approvedLoans || approvedLoans.length === 0) {
        return;
    }
    
    // Add options for each approved loan
    approvedLoans.forEach(loan => {
        const option = document.createElement('option');
        option.value = loan.referenceNumber;
        option.textContent = `${loan.loanType} Loan (R${parseInt(loan.loanAmount).toLocaleString()})`;
        paymentLoanSelect.appendChild(option);
    });
}

// Add function to load documents
function loadDocuments(applications) {
    const documentsGrid = document.getElementById('documentsGrid');
    
    if (!applications || applications.length === 0) {
        documentsGrid.innerHTML = `
            <div class="no-applications" style="grid-column: 1 / -1;">
                <i class="fas fa-folder-open"></i>
                <p>No documents available yet.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // Add approval letter for approved applications
    const approvedApps = applications.filter(app => app.status === 'Approved');
    approvedApps.forEach(app => {
        html += `
            <div class="document-card">
                <div class="document-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <h3 class="document-title">Loan Approval Letter</h3>
                <p class="document-date">Generated on ${formatDate(new Date())}</p>
                <div class="document-actions">
                    <button class="doc-btn btn-view-doc" onclick="window.location.href='approval.html'">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button class="doc-btn btn-download" onclick="window.location.href='approval.html'">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        `;
    });
    
    // Add ID document for all applications
    applications.forEach(app => {
        html += `
            <div class="document-card">
                <div class="document-icon">
                    <i class="fas fa-id-card"></i>
                </div>
                <h3 class="document-title">ID Document</h3>
                <p class="document-date">Uploaded on ${formatDate(new Date(app.applicationDate))}</p>
                <div class="document-actions">
                    <button class="doc-btn btn-view-doc" onclick="viewDocument('id_${app.referenceNumber}')">
                        <i class="fas fa-check"></i> Uploaded Sucessful
                    </button>
                </div>
            </div>
        `;
        
        html += `
            <div class="document-card">
                <div class="document-icon">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <h3 class="document-title">Bank Statement</h3>
                <p class="document-date">Uploaded on ${formatDate(new Date(app.applicationDate))}</p>
                <div class="document-actions">
                    <button class="doc-btn btn-view-doc" onclick="viewDocument('income_${app.referenceNumber}')">
                        <i class="fas fa-check"></i> Uploaded Sucessful
                    </button>
                </div>
            </div>
        `;
    });
    
    documentsGrid.innerHTML = html;
}

// Add function to load payments
function loadPayments() {
    const paymentsTableBody = document.getElementById('paymentsTableBody');
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    
    if (payments.length === 0) {
        paymentsTableBody.innerHTML = `
            <tr class="no-payments-row">
                <td colspan="5" class="no-payments-message">No payment records found. Add your payment due dates above.</td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    payments.forEach(payment => {
        const paymentDate = new Date(payment.date);
        const now = new Date();
        
        let status = 'pending';
        let statusText = 'Pending';
        
        if (paymentDate < now) {
            status = 'overdue';
            statusText = 'Overdue';
        } else if (payment.paid) {
            status = 'paid';
            statusText = 'Paid';
        }
        
        html += `
            <tr>
                <td>${formatDate(paymentDate)}</td>
                <td>${payment.loanType}</td>
                <td>R${parseInt(payment.amount).toLocaleString()}</td>
                <td><span class="payment-status payment-${status}">${statusText}</span></td>
                <td>
                    <button class="application-btn btn-view" onclick="markAsPaid('${payment.id}')">
                        <i class="fas fa-check"></i> Mark as Paid
                    </button>
                </td>
            </tr>
        `;
    });
    
    paymentsTableBody.innerHTML = html;
}

// Add payment form submission
document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const loanRef = document.getElementById('paymentLoan').value;
    const amount = document.getElementById('paymentAmount').value;
    const date = document.getElementById('paymentDate').value;
    
    if (!loanRef || !amount || !date) {
        alert('Please fill in all fields.');
        return;
    }
    
    // Get loan details
    const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
    const loan = applications.find(app => app.referenceNumber === loanRef);
    
    if (!loan) {
        alert('Loan not found.');
        return;
    }
    
    // Create payment record
    const payment = {
        id: 'payment_' + Date.now(),
        loanRef: loanRef,
        loanType: loan.loanType,
        amount: amount,
        date: date,
        paid: false,
        createdAt: new Date().toISOString()
    };
    
    // Save payment
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    payments.push(payment);
    localStorage.setItem('payments', JSON.stringify(payments));
    
    // Reset form
    this.reset();
    
    // Reload payments
    loadPayments();
});

// Add function to mark payment as paid
window.markAsPaid = function(paymentId) {
    const payments = JSON.parse(localStorage.getItem('payments') || '[]');
    const paymentIndex = payments.findIndex(p => p.id === paymentId);
    
    if (paymentIndex !== -1) {
        payments[paymentIndex].paid = true;
        localStorage.setItem('payments', JSON.stringify(payments));
        loadPayments();
    }
};

// Add function to view loan details
window.viewLoanDetails = function(referenceNumber) {
    alert(`Viewing details for loan: ${referenceNumber}`);
};

// Add function to view document
window.viewDocument = function(documentId) {
    alert(`This feature would display the document: ${documentId}`);
};

// Add function to download document
window.downloadDocument = function(documentId) {
    alert(`This feature would download the document: ${documentId}`);
};

// Add function to view application
window.viewApplication = function(referenceNumber) {
    alert(`Viewing application: ${referenceNumber}`);
};

// Add function to track application
window.trackApplication = function(referenceNumber) {
    alert(`Tracking application: ${referenceNumber}`);
};

// Modified function to view approval letter - now redirects to approval.html
window.viewApprovalLetter = function(referenceNumber) {
    // Redirect to approval.html
    window.location.href = 'approval.html';
};

// Close modal handlers
document.querySelectorAll('.close-modal, .close-modal-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('approvalLetterModal').style.display = 'none';
    });
});

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('approvalLetterModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});

// Dashboard navigation
document.querySelectorAll('[data-tab]').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        
        const targetTab = this.getAttribute('data-tab');
        
        // Remove active class from all menu items
        document.querySelectorAll('.dashboard-menu a').forEach(a => a.classList.remove('active'));
        
        // Add active class to clicked item
        if (this.classList.contains('dashboard-menu')) {
            this.classList.add('active');
        } else {
            document.querySelector(`.dashboard-menu a[data-tab="${targetTab}"]`).classList.add('active');
        }
        
        // Hide all tabs
        document.querySelectorAll('.dashboard-tab').forEach(tab => tab.classList.remove('active'));
        
        // Show target tab
        document.getElementById(targetTab + 'Tab').classList.add('active');
    });
});

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', function() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('lastLoginTime');
        location.reload();
    }
});

// Settings form submission
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const firstName = document.getElementById('settingsFirstName').value;
    const lastName = document.getElementById('settingsLastName').value;
    const phone = document.getElementById('settingsPhone').value;
    const currentPin = document.getElementById('currentPin').value;
    const newPin = document.getElementById('newPin').value;
    const confirmNewPin = document.getElementById('confirmNewPin').value;
    
    const email = localStorage.getItem('userEmail');
    const savedPin = localStorage.getItem(`pin_${email}`);
    
    // Update name and phone
    const applications = JSON.parse(localStorage.getItem('loanApplications') || '[]');
    if (applications.length > 0) {
        applications.forEach(app => {
            app.firstName = firstName;
            app.lastName = lastName;
            app.phone = phone;
        });
        localStorage.setItem('loanApplications', JSON.stringify(applications));
    }
    
    // Update PIN if provided
    if (currentPin && newPin && confirmNewPin) {
        if (currentPin !== savedPin) {
            alert('Current PIN is incorrect.');
            return;
        }
        
        if (newPin !== confirmNewPin) {
            alert('New PINs do not match.');
            return;
        }
        
        if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
            alert('PIN must be exactly 4 digits.');
            return;
        }
        
        localStorage.setItem(`pin_${email}`, newPin);
    }
    
    // Show success message
    document.getElementById('settingsSuccessMessage').style.display = 'block';
    setTimeout(() => {
        document.getElementById('settingsSuccessMessage').style.display = 'none';
    }, 3000);
    
    // Update UI
    document.getElementById('userName').textContent = firstName;
    document.getElementById('userFullName').textContent = `${firstName} ${lastName}`.trim();
    
    // Create avatar initials
    const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
    document.getElementById('userAvatar').textContent = initials;
    
    // Clear PIN fields
    document.getElementById('currentPin').value = '';
    document.getElementById('newPin').value = '';
    document.getElementById('confirmNewPin').value = '';
});

// Download letter functionality
document.getElementById('downloadLetterBtn').addEventListener('click', function() {
    alert('This feature would download the approval letter as a PDF.');
});

document.getElementById('viewApprovalLetterBtn').addEventListener('click', function() {
    window.location.href = 'approval.html';
});
</script>
</body>
</html>
