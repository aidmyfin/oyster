<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Oyster Personal Finance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-menu a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-menu a:hover {
            color: #e74c3c;
        }

        .main-content {
            margin-top: 80px;
            padding: 3rem 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Login Section */
        .login-section {
            padding: 4rem 0;
            min-height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            max-width: 500px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .login-header {
            background: linear-gradient(135deg, #1C75BC, #34495e);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .login-header h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .login-body {
            padding: 3rem;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.1);
        }

        .login-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .login-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .success-message {
            background: #27ae60;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .form-note {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .register-link {
            text-align: center;
            margin-top: 2rem;
        }

        .register-link a {
            color: #e74c3c;
            text-decoration: none;
            font-weight: bold;
        }

        /* Dashboard Section */
        .dashboard-section {
            padding: 4rem 0;
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
        }

        .welcome-message h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
        }

        .action-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-apply {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-logout {
            background: #f8f9fa;
            color: #2c3e50;
            border: 2px solid #ddd;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .dashboard-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            height: fit-content;
        }

        .user-profile {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e9ecef;
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }

        .user-name {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .user-email {
            color: #666;
            margin-bottom: 1rem;
        }

        .dashboard-menu {
            list-style: none;
        }

        .dashboard-menu li {
            margin-bottom: 1rem;
        }

        .dashboard-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            text-decoration: none;
            color: #2c3e50;
            transition: all 0.3s ease;
        }

        .dashboard-menu a:hover,
        .dashboard-menu a.active {
            background: #f8f9fa;
            color: #e74c3c;
        }

        .dashboard-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .content-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .dashboard-tab {
            display: none;
        }

        .dashboard-tab.active {
            display: block;
        }

        .loan-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            border-bottom: 4px solid #e74c3c;
        }

        .summary-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .summary-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #27ae60;
        }

        .applications-list {
            margin-bottom: 2rem;
        }

        .application-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #e74c3c;
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .application-title {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: bold;
        }

        .application-status {
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-pending {
            background: #1C75BC;
            color: white;
        }

        .status-approved {
            background: #27ae60;
            color: white;
        }

        .status-processing {
            background: #3498db;
            color: white;
        }

        .application-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .detail-value {
            font-weight: bold;
            color: #2c3e50;
        }

        .application-actions {
            display: flex;
            gap: 1rem;
        }

        .application-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-track {
            background: #2c3e50;
            color: white;
        }

        .no-applications {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .no-applications i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 1rem;
        }

        /* Application Tracking */
        .application-tracking {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .tracking-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .progress-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .progress-bar-advanced {
            height: 10px;
            background: #f1f1f1;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #27ae60);
            border-radius: 5px;
            width: 0%;
            transition: width 1.5s ease;
        }

        .progress-percentage {
            position: absolute;
            top: -25px;
            right: 0;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            transform: translateX(50%);
        }

        .tracking-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .tracking-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            text-align: center;
        }

        .step-icon {
            width: 50px;
            height: 50px;
            background: #f1f1f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            color: #666;
            font-size: 1.2rem;
            transition: all 0.5s ease;
        }

        .step-label {
            font-size: 0.9rem;
            color: #666;
        }

        .tracking-step.active .step-icon {
            background: #e74c3c;
            color: white;
            transform: scale(1.2);
        }

        .tracking-step.active .step-label {
            color: #e74c3c;
            font-weight: bold;
        }

        .tracking-step.completed .step-icon {
            background: #27ae60;
            color: white;
        }

        .tracking-step.completed .step-label {
            color: #27ae60;
        }

        .tracking-message {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.1rem;
            border-left: 4px solid #e74c3c;
            line-height: 1.6;
        }

        .tracking-actions {
            text-align: center;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            top: 100px;
            right: 20px;
            background: transparent;
            color: transparent;
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.8rem;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            top: 100px;
            right: 20px;
            background: transparent;
            color: transparent;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1002;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .welcome-message h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .loan-summary {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .application-details {
                grid-template-columns: 1fr;
            }
            
            .tracking-steps {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .tracking-step {
                width: 60px;
            }
            
            .step-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    <div class="debug-panel" id="debugPanel">
        <h4>Debug Info</h4>
        <div id="debugContent"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <div class="logo">
                <span>🦪 Oyster Finance</span>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="apply.html">Apply</a></li>
                <li><a href="profile.html">Profile</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Login Section -->
        <section class="login-section" id="loginSection">
            <div class="container">
                <div class="login-container">
                    <div class="login-header">
                        <h2>Welcome Back</h2>
                        <p>Sign in to access your account and track your loan applications</p>
                    </div>
                    <div class="login-body">
                        <div class="error-message" id="errorMessage"></div>
                        <div class="success-message" id="successMessage"></div>
                        
                        <!-- Email Form -->
                        <form id="emailForm" style="display: block;">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" placeholder="Enter your email" required>
                            </div>
                            <button type="submit" class="login-btn" id="emailButton">
                                <i class="fas fa-arrow-right"></i> Continue
                            </button>
                        </form>

                        <!-- PIN Form -->
                        <form id="pinForm" style="display: none;">
                            <div class="form-group">
                                <label for="pin">Enter PIN</label>
                                <input type="password" id="pin" name="pin" placeholder="Enter your 4-digit PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required>
                                <p class="form-note">Enter your 4-digit PIN to access your account.</p>
                            </div>
                            <button type="submit" class="login-btn" id="pinButton">
                                <i class="fas fa-sign-in-alt"></i> Sign In
                            </button>
                            <button type="button" class="login-btn" id="backButton" style="margin-top: 10px; background: #f8f9fa; color: #333;">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </form>

                        <!-- Create PIN Form -->
                        <form id="createPinForm" style="display: none;">
                            <div class="form-group">
                                <label for="newPin">Create a 4-Digit PIN</label>
                                <input type="password" id="newPin" name="newPin" placeholder="Enter 4-digit PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPin">Confirm PIN</label>
                                <input type="password" id="confirmPin" name="confirmPin" placeholder="Confirm your PIN" maxlength="4" pattern="[0-9]*" inputmode="numeric" required>
                            </div>
                            <p class="form-note">This PIN will be used for future logins along with your email.</p>
                            <button type="submit" class="login-btn" id="createPinButton">
                                <i class="fas fa-lock"></i> Create PIN
                            </button>
                        </form>

                        <div class="register-link">
                            <p>Don't have an account? <a href="apply.html">Apply for a loan to create one</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section class="dashboard-section" id="dashboardSection">
            <div class="container">
                <div class="dashboard-header">
                    <div class="welcome-message">
                        <h1>Welcome back, <span id="userName">User</span>!</h1>
                        <p>Here's an overview of your loan applications and account.</p>
                    </div>
                    <div class="action-buttons">
                        <a href="apply.html" class="action-btn btn-apply">
                            <i class="fas fa-plus"></i> New Application
                        </a>
                        <button id="logoutBtn" class="action-btn btn-logout">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- Application Tracking Section -->
                <div class="application-tracking" id="applicationTrackingSection">
                    <h2 class="tracking-title">Application Progress</h2>
                    <div class="progress-container">
                        <div class="progress-bar-advanced">
                            <div class="progress-fill" id="trackingProgressBar"></div>
                        </div>
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                    </div>
                    <div class="tracking-steps">
                        <div class="tracking-step active" data-step="1">
                            <div class="step-icon"><i class="fas fa-file-alt"></i></div>
                            <div class="step-label">Submitted</div>
                        </div>
                        <div class="tracking-step" data-step="2">
                            <div class="step-icon"><i class="fas fa-search"></i></div>
                            <div class="step-label">Processing</div>
                        </div>
                        <div class="tracking-step" data-step="3">
                            <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="step-label">Qualified</div>
                        </div>
                        <div class="tracking-step" data-step="4">
                            <div class="step-icon"><i class="fas fa-flag"></i></div>
                            <div class="step-label">Review</div>
                        </div>
                        <div class="tracking-step" data-step="5">
                            <div class="step-icon"><i class="fas fa-file-signature"></i></div>
                            <div class="step-label">Approved</div>
                        </div>
                    </div>
                    <div class="tracking-message" id="trackingMessage">
                        Your application has been submitted and is now being processed. We'll update you shortly.
                    </div>
                    <div class="tracking-actions" id="trackingActions" style="display: none;">
                        <button class="login-btn" onclick="window.location.href='approval.html'">
                            <i class="fas fa-file-pdf"></i> View Approval Letter
                        </button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-sidebar">
                        <div class="user-profile">
                            <div class="user-avatar" id="userAvatar">U</div>
                            <h3 class="user-name" id="userFullName">User</h3>
                            <p class="user-email" id="userEmail">user@example.com</p>
                        </div>
                        <ul class="dashboard-menu">
                            <li>
                                <a href="#" class="active" data-tab="applications">
                                    <i class="fas fa-file-alt"></i> My Applications
                                </a>
                            </li>
                            <li>
                                <a href="#" data-tab="loans">
                                    <i class="fas fa-money-bill-wave"></i> Active Loans
                                </a>
                            </li>
                            <li>
                                <a href="#" data-tab="documents">
                                    <i class="fas fa-folder"></i> Documents
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="dashboard-content">
                        <!-- Applications Tab -->
                        <div class="dashboard-tab active" id="applicationsTab">
                            <h2 class="content-title">My Applications</h2>
                            <div class="loan-summary">
                                <div class="summary-card">
                                    <div class="summary-title">Total Applications</div>
                                    <div class="summary-value" id="totalApplications">0</div>
                                    <div class="summary-change">
                                        <i class="fas fa-arrow-up"></i> <span id="newApplications">0</span> new this month
                                    </div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Approved Applications</div>
                                    <div class="summary-value" id="approvedApplications">0</div>
                                    <div class="summary-change">
                                        <i class="fas fa-check-circle"></i> <span id="approvalRate">0</span>% approval rate
                                    </div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Pending Applications</div>
                                    <div class="summary-value" id="pendingApplications">0</div>
                                    <div class="summary-change">
                                        <i class="fas fa-clock"></i> Expected response: 24h
                                    </div>
                                </div>
                            </div>
                            <div class="applications-list" id="applicationsList">
                                <!-- Applications will be loaded here -->
                            </div>
                        </div>

                        <!-- Active Loans Tab -->
                        <div class="dashboard-tab" id="loansTab">
                            <h2 class="content-title">Active Loans</h2>
                            <div class="loan-summary">
                                <div class="summary-card">
                                    <div class="summary-title">Total Loan Amount</div>
                                    <div class="summary-value" id="totalLoanAmount">R0</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Monthly Payment</div>
                                    <div class="summary-value" id="monthlyPayment">R0</div>
                                </div>
                                <div class="summary-card">
                                    <div class="summary-title">Outstanding Balance</div>
                                    <div class="summary-value" id="outstandingBalance">R0</div>
                                </div>
                            </div>
                            <div id="activeLoansContent">
                                <div class="no-applications">
                                    <i class="fas fa-info-circle"></i>
                                    <p>You don't have any active loans at the moment.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Tab -->
                        <div class="dashboard-tab" id="documentsTab">
                            <h2 class="content-title">My Documents</h2>
                            <div id="documentsContent">
                                <div class="no-applications">
                                    <i class="fas fa-folder-open"></i>
                                    <p>No documents available yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Configuration
        const CONFIG = {
            BASEROW_API_URL: 'https://api.baserow.io/api/database/rows/table/',
            BASEROW_API_KEY: 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL',
            BASEROW_TABLE_ID: '561419',
            // Use field IDs instead of field names for exact matching
            FIELDS: {
                EMAIL: '4502368',
                LOAN_AMOUNT: '4501398',
                LOAN_PURPOSE: '4502388',
                LOAN_TERM: '4502389',
                INCOME: '4502376',
                NAME: '4501396'
            }
        };

        // Global state
        let currentUser = null;
        let userApplications = [];
        let debugMode = false;

        // Debug functions
        function log(message, data = null) {
            console.log(`[Oyster Finance] ${message}`, data || '');
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div><strong>${timestamp}:</strong> ${message}</div>`;
                if (data) {
                    debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.style.display = debugMode ? 'block' : 'none';
            if (debugMode) {
                log('Debug mode enabled');
            }
        }

        // Utility functions
        function showError(message) {
            log(`Error: ${message}`);
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            log(`Success: ${message}`);
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-ZA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function generateReferenceNumber(id) {
            return `OPF-${String(id).padStart(5, '0')}`;
        }

        // Baserow API functions
        async function checkEmailInBaserow(email) {
    try {
        log(`=== STARTING EMAIL CHECK ===`);
        log(`Checking email in Baserow: ${email}`);
        
        const url = `${CONFIG.BASEROW_API_URL}${CONFIG.BASEROW_TABLE_ID}/`;
        log(`API URL: ${url}`);
        log(`API Key: ${CONFIG.BASEROW_API_KEY.substring(0, 10)}...`);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Token ${CONFIG.BASEROW_API_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        log(`API Response Status: ${response.status}`);
        log(`API Response OK: ${response.ok}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            log(`API Error Response: ${errorText}`);
            return null;
        }
        
        const data = await response.json();
        log('=== FULL API RESPONSE ===');
        log('Response structure:', {
            hasResults: !!data.results,
            resultsLength: data.results ? data.results.length : 0,
            firstRecordKeys: data.results && data.results.length > 0 ? Object.keys(data.results[0]) : []
        });
        
        if (!data.results || !Array.isArray(data.results)) {
            log('Invalid API response structure - no results array');
            return null;
        }
        
        if (data.results.length === 0) {
            log('No records found in database');
            return null;
        }
        
        // Log the first record to see all available fields
        log('=== FIRST RECORD ANALYSIS ===');
        const firstRecord = data.results[0];
        log('All field keys in first record:', Object.keys(firstRecord));
        
        // Try different field ID formats
        const possibleEmailFields = [
            `field_${CONFIG.FIELDS.EMAIL}`,  // field_4502368
            CONFIG.FIELDS.EMAIL,             // 4502368
            'Email',                         // Field name
            'email'                          // lowercase
        ];
        
        log('Trying these email field variations:', possibleEmailFields);
        
        // Check what email values exist in the first record
        possibleEmailFields.forEach(fieldKey => {
            const value = firstRecord[fieldKey];
            log(`Field "${fieldKey}": ${value}`);
        });
        
        // Search through all records
        log('=== SEARCHING ALL RECORDS ===');
        let userRecord = null;
        
        for (let i = 0; i < data.results.length; i++) {
            const record = data.results[i];
            log(`--- Record ${i + 1} ---`);
            
            // Try each possible email field
            for (const fieldKey of possibleEmailFields) {
                const recordEmail = record[fieldKey];
                
                if (recordEmail) {
                    log(`Found email in field "${fieldKey}": "${recordEmail}"`);
                    
                    // Clean and compare emails
                    const cleanRecordEmail = recordEmail.toString().toLowerCase().trim();
                    const cleanInputEmail = email.toLowerCase().trim();
                    
                    log(`Comparing: "${cleanRecordEmail}" === "${cleanInputEmail}"`);
                    
                    if (cleanRecordEmail === cleanInputEmail) {
                        log(`✅ MATCH FOUND! Record ${i + 1}`);
                        userRecord = record;
                        break;
                    }
                }
            }
            
            if (userRecord) break;
        }
        
        if (userRecord) {
            log('=== USER FOUND ===');
            log('Matched user record:', userRecord);
            return userRecord;
        }
        
        log('=== NO MATCH FOUND ===');
        log(`Searched ${data.results.length} records for email: ${email}`);
        
        // Log all emails found in database for debugging
        const allEmails = [];
        data.results.forEach((record, index) => {
            possibleEmailFields.forEach(fieldKey => {
                const emailValue = record[fieldKey];
                if (emailValue) {
                    allEmails.push(`Record ${index + 1} (${fieldKey}): ${emailValue}`);
                }
            });
        });
        
        log('All emails found in database:', allEmails);
        
        return null;
        
    } catch (error) {
        log('=== ERROR IN EMAIL CHECK ===');
        log('Error details:', error);
        log('Error message:', error.message);
        log('Error stack:', error.stack);
        return null;
    }
}

async function fetchUserApplicationsFromBaserow(email) {
    try {
        log(`Fetching user applications for: ${email}`);
        
        const response = await fetch(`${CONFIG.BASEROW_API_URL}${CONFIG.BASEROW_TABLE_ID}/`, {
            method: 'GET',
            headers: {
                'Authorization': `Token ${CONFIG.BASEROW_API_KEY}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        log('Fetched data from Baserow:', data);
        
        // Use field IDs for exact matching
        const emailFieldId = `field_${CONFIG.FIELDS.EMAIL}`;
        const loanAmountFieldId = `field_${CONFIG.FIELDS.LOAN_AMOUNT}`;
        const loanPurposeFieldId = `field_${CONFIG.FIELDS.LOAN_PURPOSE}`;
        const loanTermFieldId = `field_${CONFIG.FIELDS.LOAN_TERM}`;
        const incomeFieldId = `field_${CONFIG.FIELDS.INCOME}`;
        const nameFieldId = `field_${CONFIG.FIELDS.NAME}`;
        
        log('Using field IDs:', {
            email: emailFieldId,
            loanAmount: loanAmountFieldId,
            loanPurpose: loanPurposeFieldId,
            loanTerm: loanTermFieldId,
            income: incomeFieldId,
            name: nameFieldId
        });
        
        // Filter records by email using field ID
        const userRecords = data.results.filter(result => {
            const recordEmail = result[emailFieldId];
            if (!recordEmail) return false;
            
            const cleanRecordEmail = recordEmail.toString().toLowerCase().trim();
            const cleanInputEmail = email.toLowerCase().trim();
            
            return cleanRecordEmail === cleanInputEmail;
        });
        
        log(`Found ${userRecords.length} records for user`);
        
        if (userRecords.length === 0) {
            userApplications = [];
            return [];
        }
        
        // Process applications using field IDs
        userApplications = userRecords.map(result => {
            const createdDate = new Date(result.created_on);
            const now = new Date();
            const minutesPassed = Math.floor((now - createdDate) / (1000 * 60));
            
            let status = 'Pending';
            if (minutesPassed >= 10) {
                status = 'Approved';
            } else if (minutesPassed >= 1) {
                status = 'Processing';
            }
            
            // Extract data using specific field IDs
            const loanAmount = result[loanAmountFieldId] || 0;
            const loanPurpose = result[loanPurposeFieldId] || 'General';
            const loanTerm = result[loanTermFieldId] || 12;
            const income = result[incomeFieldId] || 0;
            const name = result[nameFieldId] || 'User';
            
            log('Extracted field data:', {
                loanAmount,
                loanPurpose,
                loanTerm,
                income,
                name
            });
            
            return {
                id: result.id,
                referenceNumber: generateReferenceNumber(result.id),
                loanType: 'Personal', // Default type
                loanAmount: loanAmount,
                loanPurpose: loanPurpose,
                loanTerm: loanTerm,
                firstName: name,
                lastName: '',
                idNumber: result.idNo || result.id_number || result.IdNo || '',
                email: result[emailFieldId] || email,
                phone: result.Phonenumber || result.phone_number || result.phone || '',
                employmentStatus: result.employ || result.employment || 'Employed',
                monthlyIncome: income,
                applicationDate: result.created_on || new Date().toISOString(),
                status: status,
                baserowId: result.id
            };
        });
        
        log(`Processed ${userApplications.length} applications with field data`);
        
        // Store in localStorage
        localStorage.setItem('loanApplications', JSON.stringify(userApplications));
        localStorage.setItem('userEmail', email);
        
        return userApplications;
        
    } catch (error) {
        log('Error fetching applications:', error);
        // Try localStorage fallback
        const storedApps = localStorage.getItem('loanApplications');
        if (storedApps) {
            userApplications = JSON.parse(storedApps);
            log(`Loaded ${userApplications.length} applications from localStorage`);
            return userApplications;
        }
        return [];
    }
}
        // Authentication functions
        function isLoggedIn() {
            return localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('userEmail');
        }

        function login(email) {
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userEmail', email);
            localStorage.setItem('lastLoginTime', new Date().toISOString());
            log(`User logged in: ${email}`);
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('lastLoginTime');
            currentUser = null;
            userApplications = [];
            log('User logged out');
            location.reload();
        }

        // UI functions
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            log('Dashboard shown');
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            log('Login shown');
        }

        function updateUserProfile() {
            const email = localStorage.getItem('userEmail');
            
            if (userApplications.length > 0) {
                const firstApp = userApplications[0];
                const firstName = firstApp.firstName || 'User';
                const lastName = firstApp.lastName || '';
                const fullName = `${firstName} ${lastName}`.trim();
                
                document.getElementById('userName').textContent = firstName;
                document.getElementById('userFullName').textContent = fullName;
                document.getElementById('userEmail').textContent = email;
                
                // Create avatar initials
                const initials = `${firstName.charAt(0)}${lastName.charAt(0)}`.toUpperCase();
                document.getElementById('userAvatar').textContent = initials;
                
                log(`Updated user profile: ${fullName} (${email})`);
            } else {
                document.getElementById('userName').textContent = 'User';
                document.getElementById('userFullName').textContent = 'User';
                document.getElementById('userEmail').textContent = email;
                document.getElementById('userAvatar').textContent = 'U';
            }
        }

        function loadApplications() {
            log(`Loading ${userApplications.length} applications`);
            
            const applicationsList = document.getElementById('applicationsList');
            
            // Update summary cards
            const totalApps = userApplications.length;
            const approvedApps = userApplications.filter(app => app.status === 'Approved');
            const pendingApps = userApplications.filter(app => app.status === 'Pending' || app.status === 'Processing');
            
            document.getElementById('totalApplications').textContent = totalApps;
            document.getElementById('approvedApplications').textContent = approvedApps.length;
            document.getElementById('pendingApplications').textContent = pendingApps.length;
            
            if (totalApps > 0) {
                const approvalRate = Math.round((approvedApps.length / totalApps) * 100);
                document.getElementById('approvalRate').textContent = approvalRate;
            }
            
            if (userApplications.length === 0) {
                applicationsList.innerHTML = `
                    <div class="no-applications">
                        <i class="fas fa-file-alt"></i>
                        <p>No loan applications found.</p>
                        <a href="apply.html" class="action-btn btn-apply">
                            <i class="fas fa-plus"></i> Apply for a Loan
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userApplications.forEach(app => {
                const amount = parseInt(app.loanAmount) || 0;
                const statusClass = getStatusClass(app.status);
                
                html += `
                    <div class="application-card">
                        <div class="application-header">
                            <div class="application-title">${app.loanType} Loan</div>
                            <div class="application-status ${statusClass}">${app.status}</div>
                        </div>
                        <div class="application-details">
                            <div class="detail-item">
                                <div class="detail-label">Reference Number</div>
                                <div class="detail-value">${app.referenceNumber}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Amount</div>
                                <div class="detail-value">R${amount.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Purpose</div>
                                <div class="detail-value">${app.loanPurpose}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Term</div>
                                <div class="detail-value">${app.loanTerm} months</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Application Date</div>
                                <div class="detail-value">${formatDate(new Date(app.applicationDate))}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Monthly Income</div>
                                <div class="detail-value">R${parseInt(app.monthlyIncome || 0).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="application-btn btn-view" onclick="viewApplication('${app.referenceNumber}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${app.status === 'Approved' ? 
                                `<button class="application-btn btn-track" onclick="window.location.href='approval.html'">
                                    <i class="fas fa-file-pdf"></i> View Letter
                                </button>` : 
                                `<button class="application-btn btn-track" onclick="trackApplication('${app.referenceNumber}')">
                                    <i class="fas fa-search"></i> Track
                                </button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            applicationsList.innerHTML = html;
            
            // Load active loans
            loadActiveLoans(approvedApps);
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Approved': return 'status-approved';
                case 'Pending': return 'status-pending';
                case 'Processing': return 'status-processing';
                default: return 'status-pending';
            }
        }

        function loadActiveLoans(approvedLoans) {
            const activeLoansContent = document.getElementById('activeLoansContent');
            
            if (!approvedLoans || approvedLoans.length === 0) {
                document.getElementById('totalLoanAmount').textContent = 'R0';
                document.getElementById('monthlyPayment').textContent = 'R0';
                document.getElementById('outstandingBalance').textContent = 'R0';
                
                activeLoansContent.innerHTML = `
                    <div class="no-applications">
                        <i class="fas fa-info-circle"></i>
                        <p>You don't have any active loans at the moment.</p>
                    </div>
                `;
                return;
            }
            
            // Calculate totals
            let totalAmount = 0;
            let totalMonthlyPayment = 0;
            let totalOutstanding = 0;
            
            approvedLoans.forEach(loan => {
                const amount = parseInt(loan.loanAmount) || 0;
                totalAmount += amount;
                totalMonthlyPayment += Math.round(amount * 0.05); // 5% monthly payment estimate
                totalOutstanding += amount * 0.9; // 90% outstanding estimate
            });
            
            document.getElementById('totalLoanAmount').textContent = `R${totalAmount.toLocaleString()}`;
            document.getElementById('monthlyPayment').textContent = `R${totalMonthlyPayment.toLocaleString()}`;
            document.getElementById('outstandingBalance').textContent = `R${Math.round(totalOutstanding).toLocaleString()}`;
            
            // Generate loans HTML
            let html = '';
            approvedLoans.forEach(loan => {
                const amount = parseInt(loan.loanAmount) || 0;
                const monthlyPayment = Math.round(amount * 0.05);
                const outstanding = amount * 0.9;
                
                html += `
                    <div class="application-card">
                        <div class="application-header">
                            <div class="application-title">${loan.loanType} Loan</div>
                            <div class="application-status status-approved">Active</div>
                        </div>
                        <div class="application-details">
                            <div class="detail-item">
                                <div class="detail-label">Reference Number</div>
                                <div class="detail-value">${loan.referenceNumber}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Loan Amount</div>
                                <div class="detail-value">R${amount.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Monthly Payment</div>
                                <div class="detail-value">R${monthlyPayment.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Outstanding Balance</div>
                                <div class="detail-value">R${Math.round(outstanding).toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="application-actions">
                            <button class="application-btn btn-view" onclick="viewLoanDetails('${loan.referenceNumber}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="application-btn btn-track" onclick="window.location.href='approval.html'">
                                <i class="fas fa-file-pdf"></i> View Letter
                            </button>
                        </div>
                    </div>
                `;
            });
            
            activeLoansContent.innerHTML = html;
        }

        // Application tracking
        function startApplicationTracking(application) {
            log(`Starting tracking for application: ${application.referenceNumber}`);
            
            const createdDate = new Date(application.applicationDate);
            const now = new Date();
            const minutesPassed = Math.floor((now - createdDate) / (1000 * 60));
            
            const progressBar = document.getElementById('trackingProgressBar');
            const progressPercentage = document.getElementById('progressPercentage');
            const steps = document.querySelectorAll('.tracking-step');
            const trackingMessage = document.getElementById('trackingMessage');
            const trackingActions = document.getElementById('trackingActions');
            
            // Reset
            steps.forEach(step => step.classList.remove('active', 'completed'));
            trackingActions.style.display = 'none';
            
            let progress = 0;
            let message = '';
            
            if (minutesPassed < 1) {
                progress = 30;
                steps[0].classList.add('active');
                message = 'Your application has been submitted and is now being processed.';
            } else if (minutesPassed < 5) {
                progress = 75;
                steps[0].classList.add('completed');
                steps[1].classList.add('completed');
                steps[2].classList.add('active');
                const firstName = application.firstName || 'Applicant';
                const amount = parseInt(application.loanAmount).toLocaleString();
                message = `<strong>Congratulations ${firstName}!</strong> You have qualified for the R${amount} loan application.`;
            } else {
                progress = 100;
                steps.forEach(step => step.classList.add('completed'));
                message = `
                    <strong>Congratulations!</strong> Your loan application has been <strong>APPROVED</strong>.<br>
                    <strong>Flagged for Low Credit Issue</strong><br>
                    A credit improvement and cover will be needed.<br>
                    <small style="color: #e74c3c; font-weight: bold;">Do not worry, we have the solution for you!</small><br><br>
                    <strong>Your approval letter is ready!</strong>
                `;
                trackingActions.style.display = 'block';
            }
            
            // Animate progress bar
            progressBar.style.width = progress + '%';
            progressPercentage.textContent = progress + '%';
            progressPercentage.style.right = (100 - progress) + '%';
            
            trackingMessage.innerHTML = message;
            
            log(`Tracking updated: ${progress}% progress`);
        }

        // Event handlers
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const emailButton = document.getElementById('emailButton');
            
            if (!email) {
                showError('Please enter your email address.');
                return;
            }
            
            // Show loading
            const originalText = emailButton.innerHTML;
            emailButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            emailButton.disabled = true;
            
            log(`=== EMAIL FORM SUBMISSION ===`);
            log(`Email entered: ${email}`);
            
            try {
                // Check email in Baserow
                const userRecord = await checkEmailInBaserow(email);
                
                log(`Email check completed. Result:`, userRecord ? 'FOUND' : 'NOT FOUND');
                
                if (!userRecord) {
                    log('Showing "no applications found" error');
                    showError('No applications found with this email address. Please apply for a loan first.');
                    emailButton.innerHTML = originalText;
                    emailButton.disabled = false;
                    return;
                }
                
                log('User record found, proceeding to PIN check');
                
                // Check if PIN exists
                const savedPin = localStorage.getItem(`pin_${email}`);
                
                if (!savedPin) {
                    log('No PIN found, showing PIN creation form');
                    document.getElementById('emailForm').style.display = 'none';
                    document.getElementById('createPinForm').style.display = 'block';
                    sessionStorage.setItem('tempEmail', email);
                } else {
                    log('PIN found, showing PIN entry form');
                    document.getElementById('emailForm').style.display = 'none';
                    document.getElementById('pinForm').style.display = 'block';
                    sessionStorage.setItem('tempEmail', email);
                }
                
                emailButton.innerHTML = originalText;
                emailButton.disabled = false;
                
            } catch (error) {
                log('=== ERROR IN EMAIL FORM ===');
                log('Caught error:', error);
                showError('Connection error. Please check your internet and try again.');
                emailButton.innerHTML = originalText;
                emailButton.disabled = false;
            }
        });

        document.getElementById('pinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const pin = document.getElementById('pin').value.trim();
            const email = sessionStorage.getItem('tempEmail');
            const pinButton = document.getElementById('pinButton');
            
            if (!pin) {
                showError('Please enter your PIN.');
                return;
            }
            
            const originalText = pinButton.innerHTML;
            pinButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            pinButton.disabled = true;
            
            try {
                const savedPin = localStorage.getItem(`pin_${email}`);
                
                if (pin !== savedPin) {
                    showError('Incorrect PIN. Please try again.');
                    document.getElementById('pin').value = '';
                    pinButton.innerHTML = originalText;
                    pinButton.disabled = false;
                    return;
                }
                
                // Login successful
                login(email);
                await fetchUserApplicationsFromBaserow(email);
                showDashboard();
                updateUserProfile();
                loadApplications();
                
                // Start tracking for pending applications
                const pendingApps = userApplications.filter(app => 
                    app.status === 'Pending' || app.status === 'Processing'
                );
                
                if (pendingApps.length > 0) {
                    startApplicationTracking(pendingApps[0]);
                } else {
                    document.getElementById('applicationTrackingSection').style.display = 'none';
                }
                
                sessionStorage.removeItem('tempEmail');
                
            } catch (error) {
                showError('Login failed. Please try again.');
                pinButton.innerHTML = originalText;
                pinButton.disabled = false;
            }
        });

        document.getElementById('createPinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;
            const email = sessionStorage.getItem('tempEmail');
            
            if (newPin !== confirmPin) {
                showError('PINs do not match. Please try again.');
                return;
            }
            
            if (newPin.length !== 4 || !/^\d+$/.test(newPin)) {
                showError('PIN must be exactly 4 digits.');
                return;
            }
            
            // Save PIN and login
            localStorage.setItem(`pin_${email}`, newPin);
            login(email);
            
            await fetchUserApplicationsFromBaserow(email);
            showDashboard();
            updateUserProfile();
            loadApplications();
            
            // Start tracking
            const pendingApps = userApplications.filter(app => 
                app.status === 'Pending' || app.status === 'Processing'
            );
            
            if (pendingApps.length > 0) {
                startApplicationTracking(pendingApps[0]);
            } else {
                document.getElementById('applicationTrackingSection').style.display = 'none';
            }
            
            sessionStorage.removeItem('tempEmail');
            showSuccess('PIN created successfully! Welcome to your dashboard.');
        });

        document.getElementById('backButton').addEventListener('click', function() {
            document.getElementById('pinForm').style.display = 'none';
            document.getElementById('emailForm').style.display = 'block';
            document.getElementById('pin').value = '';
        });

        // Dashboard navigation
        document.querySelectorAll('[data-tab]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                const targetTab = this.getAttribute('data-tab');
                
                // Remove active class from all menu items
                document.querySelectorAll('.dashboard-menu a').forEach(a => a.classList.remove('active'));
                this.classList.add('active');
                
                // Hide all tabs
                document.querySelectorAll('.dashboard-tab').forEach(tab => tab.classList.remove('active'));
                
                // Show target tab
                document.getElementById(targetTab + 'Tab').classList.add('active');
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                logout();
            }
        });

        // Global functions
        window.viewApplication = function(referenceNumber) {
            alert(`Viewing application: ${referenceNumber}`);
        };

        window.trackApplication = function(referenceNumber) {
            alert(`Tracking application: ${referenceNumber}`);
        };

        window.viewLoanDetails = function(referenceNumber) {
            alert(`Viewing loan details: ${referenceNumber}`);
        };

        // Initialize
        window.addEventListener('load', async function() {
            log('Application starting...');
            
            if (isLoggedIn()) {
                const userEmail = localStorage.getItem('userEmail');
                log(`User already logged in: ${userEmail}`);
                
                try {
                    // Verify email still exists
                    const userRecord = await checkEmailInBaserow(userEmail);
                    
                    if (!userRecord) {
                        log('User email no longer exists in Baserow, logging out');
                        logout();
                        return;
                    }
                    
                    await fetchUserApplicationsFromBaserow(userEmail);
                    showDashboard();
                    updateUserProfile();
                    loadApplications();
                    
                    // Start tracking
                    const pendingApps = userApplications.filter(app => 
                        app.status === 'Pending' || app.status === 'Processing'
                    );
                    
                    if (pendingApps.length > 0) {
                        startApplicationTracking(pendingApps[0]);
                    } else {
                        document.getElementById('applicationTrackingSection').style.display = 'none';
                    }
                    
                } catch (error) {
                    log('Error verifying user on load:', error);
                    showLogin();
                }
            } else {
                log('User not logged in, showing login form');
                showLogin();
            }
        });
    </script>
</body>
</html>
